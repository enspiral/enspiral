- title("Invoices")
.row
  %h1.span5 #{@invoiceable.name} Invoices
  .model_actions
    = link_to 'New Invoice', [:new, @invoiceable, :invoice], class: 'btn'

%h3.bottom_margin.gray_ink
  Total: #{number_to_currency(@invoices.inject(0) {|total, i| total += i.amount})}

%p
  - if action_name == 'closed'
    = link_to 'Open invoices', [@invoiceable, Invoice]
  - else
    = link_to 'Closed invoices',[:closed, @invoiceable, Invoice]

.invoices
  %nav
    .nav.table_actions
      %ul.nav.nav-tabs
        %li.nav_label Find:
        .search_box.navbar-form.pull-left
          =text_field_tag :search, nil, :class => "input-small"
  - if @invoices.size > 0
    %table.table.table-striped.one_action.invoices_table.tablesorter
      %thead
        %th
        %th ID
        %th{class: "{sorter: 'currency'}"} Amount
        %th To Disburse
        %th Customer
        %th Created
        %th Due
        %th Overdue
        %th Paid?
      %tbody
        - for invoice in @invoices
          %tr
            %td.actions
              -if invoice.allocated_in_full? and !invoice.paid_in_full?
                =link_to [:pay_and_disburse, @invoiceable, invoice], pay_and_disburse_options(invoice) do
                  %i.icon-download-alt
            %td 
              =link_to "##{invoice.reference}", [@invoiceable, invoice]
            %td
              %span{class: "#{invoice.disbursed? ? 'green_ink' : 'red_ink'}"}
                =number_to_currency(invoice.amount, delimiter: '')
            %td{class: "#{'red_ink' if invoice.amount_disbursable < 0}"}
              =number_to_currency(invoice.amount_disbursable, delimiter: '')
            %td.text_filter
              =link_to invoice.customer.name, invoice.customer
            %td
              =l invoice.date, format: :sortable
            %td{class: "#{ invoice.due < Date.today ? 'red_ink' : 'green_ink'}"}
              =l invoice.due, format: :sortable
            %td
              = invoice.overdue? ? 'overdue' : ''
            %td
              = invoice.paid? ? 'paid' : 'unpaid'

=content_for :javascripts do
  :coffeescript
    @search_filter = new Enspiral.Views.SimpleFilterSearch
      el: '.invoices'

    $('.tablesorter').tablesorter()
